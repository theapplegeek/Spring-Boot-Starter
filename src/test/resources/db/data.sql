CREATE TABLE public.PERMISSION
(
    ID   BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    NAME VARCHAR(255) NOT NULL
        CONSTRAINT UK_PERMISSION_NAME UNIQUE
);

CREATE TABLE public.ROLE
(
    ID   BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    NAME VARCHAR(255) NOT NULL
        CONSTRAINT UK_ROLE_NAME UNIQUE
);

CREATE TABLE public.ROLE_PERMISSION
(
    ROLE_ID       BIGINT NOT NULL
        CONSTRAINT FK_ROLE_ID REFERENCES public.ROLE,
    PERMISSION_ID BIGINT NOT NULL
        CONSTRAINT FK_PERMISSION_ID REFERENCES public.PERMISSION,
    CONSTRAINT UK_ROLE_ID_PERMISSION_ID PRIMARY KEY (ROLE_ID, PERMISSION_ID)
);

CREATE TABLE public.USER_PROFILE
(
    ID       BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    EMAIL    VARCHAR(255) NOT NULL
        CONSTRAINT UK_USER_PROFILE_EMAIL UNIQUE,
    ENABLED  BOOLEAN      NOT NULL,
    NAME     VARCHAR(255) NOT NULL,
    PASSWORD VARCHAR(255) NOT NULL,
    SURNAME  VARCHAR(255) NOT NULL,
    USERNAME VARCHAR(255) NOT NULL
        CONSTRAINT UK_USER_PROFILE_USERNAME UNIQUE
);

CREATE TABLE public.TOKEN
(
    ID         BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    EXPIRATION TIMESTAMP(6)   NOT NULL,
    REVOKED    BOOLEAN        NOT NULL,
    TOKEN      VARCHAR(10240) NOT NULL
        CONSTRAINT UK_TOKEN UNIQUE,
    TOKEN_TYPE VARCHAR(255)   NOT NULL
        CONSTRAINT TOKEN_TOKEN_TYPE_CHECK CHECK ((TOKEN_TYPE)::TEXT = ANY
                                                 ((ARRAY ['BEARER'::CHARACTER VARYING, 'RESET_PASSWORD'::CHARACTER VARYING])::TEXT[])),
    USER_ID    BIGINT         NOT NULL
        CONSTRAINT FK_USER_ID REFERENCES public.USER_PROFILE
);

CREATE TABLE public.USER_ROLE
(
    USER_ID BIGINT NOT NULL
        CONSTRAINT FK_USER_ID REFERENCES public.USER_PROFILE,
    ROLE_ID BIGINT NOT NULL
        CONSTRAINT FK_ROLE_ID REFERENCES public.ROLE,
    CONSTRAINT UK_USER_ID_ROLE_ID PRIMARY KEY (USER_ID, ROLE_ID)
);

INSERT INTO role (name)
VALUES ('user'),
       ('admin');

INSERT INTO permission (name)
VALUES ('USER_READ'),
       ('USER_CREATE'),
       ('USER_UPDATE'),
       ('USER_CHANGE_PASSWORD'),
       ('USER_DELETE'),
       ('ROLE_READ'),
       ('PERMISSION_READ'),
       ('QUARTZ_JOB_READ'),
       ('QUARTZ_JOB_UPDATE');

INSERT INTO role_permission (role_id, permission_id)
VALUES (1, 4),
       (2, 1),
       (2, 2),
       (2, 3),
       (2, 4),
       (2, 5),
       (2, 6),
       (2, 7),
       (2, 8),
       (2, 9);

INSERT INTO user_profile (email, enabled, password, username, name, surname)
VALUES ('admin@mail.com', true, '$2a$10$KWYO4oLjsHyydrEcXL.CseiYe144WLp5C6rczHwDjDU2eNWlaoU7S',
        'admin', 'Admin', 'Admin'),
       ('user@mail.com', true, '$2a$10$KWYO4oLjsHyydrEcXL.CseiYe144WLp5C6rczHwDjDU2eNWlaoU7S',
        'user', 'User', 'User');

INSERT INTO user_role (user_id, role_id)
VALUES (1, 2),
       (2, 1);
